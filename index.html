<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Plot Locator ‚Äî GitHub-ready</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  html,body{height:100%;margin:0;padding:0;font-family:Arial,Helvetica,sans-serif}
  #map{height:100%;width:100%}

  /* top control panel */
  .topPanel{
    position: absolute; left:10px; top:10px; z-index:1400;
    background:#fff; padding:10px; border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,0.12);
    min-width:220px;
  }
  .topPanel .row{display:flex;gap:8px;flex-wrap:wrap}
  .btn{padding:8px 10px;border-radius:8px;border:none;cursor:pointer;font-size:14px}
  .btn.primary{background:#1976d2;color:#fff}
  .btn.secondary{background:#4caf50;color:#fff}
  .btn.zoom{background:#ff9800;color:#fff}
  .toggleBtn{background:#fff;border:1px solid #ddd;border-radius:8px;padding:6px 8px;cursor:pointer}

  .info{margin-top:6px;font-size:13px;color:#222}

  /* bottom search */
  .searchBar{
    position: fixed; left:50%; transform:translateX(-50%); bottom:14px; z-index:1400;
    background:#fff; padding:8px; border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,0.12);
    display:flex; gap:8px; align-items:center; width:calc(100% - 40px); max-width:900px;
  }
  .searchBar input{flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px}
  .searchBar button{padding:8px 12px;border-radius:6px;border:none;background:#ff5722;color:#fff;cursor:pointer;font-size:15px}

  .msg{position:fixed;left:50%;transform:translateX(-50%);top:18px;background:#fff;padding:8px 12px;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.15);z-index:1500;display:none}

  /* zoom control left-center */
  .leaflet-control-zoom{ top:50% !important; transform:translateY(-50%); left:10px !important; }

  @media (max-width:420px){
    .topPanel{min-width:180px}
    .searchBar input{font-size:14px}
  }
</style>
</head>
<body>
  <div id="map" aria-hidden="false"></div>

  <div class="topPanel" role="region" aria-label="Controls">
    <div style="font-weight:700;margin-bottom:6px">Plot Locator (‡§π‡§ø‡§®‡•ç‡§¶‡•Ä)</div>

    <div class="row">
      <button id="btnLocate" class="btn primary" title="‡§Æ‡•á‡§∞‡•Ä ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§¢‡•Ç‡§Å‡§¢‡•ã">üìç ‡§Æ‡•á‡§∞‡•Ä ‡§≤‡•ã‡§ï‡•á‡§∂‡§®</button>
      <button id="btnFit" class="btn secondary" title="‡§™‡•Ç‡§∞‡§æ ‡§Æ‡•à‡§™ ‡§¶‡§ø‡§ñ‡§æ‡§ì">üó∫Ô∏è ‡§™‡•Ç‡§∞‡§æ ‡§Æ‡•à‡§™ ‡§¶‡§ø‡§ñ‡§æ‡§ì</button>
    </div>

    <div style="margin-top:8px;" class="row">
      <button id="btnToggleLabels" class="toggleBtn" title="‡§™‡•ç‡§≤‡•â‡§ü ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å/‡§õ‡•Å‡§™‡§æ‡§è‡§Å">‡§™‡•ç‡§≤‡•â‡§ü ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å</button>
      <button id="btnVoiceToggle" class="toggleBtn" title="‡§Ü‡§µ‡§æ‡§ú‡§º ‡§ö‡§æ‡§≤‡•Ç/‡§¨‡§Ç‡§¶">‡§Ü‡§µ‡§æ‡§ú‡§º: ‡§ö‡§æ‡§≤‡•Ç</button>
    </div>

    <div style="margin-top:8px;" class="row">
      <button id="btnZoomIn" class="btn zoom" title="‡§ú‡§º‡•Ç‡§Æ ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç">üîé+</button>
      <button id="btnZoomOut" class="btn zoom" title="‡§ú‡§º‡•Ç‡§Æ ‡§Ü‡§â‡§ü ‡§ï‡§∞‡•á‡§Ç">üîé-</button>
    </div>

    <div class="info" id="info">‡§Æ‡•à‡§™ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à‚Ä¶</div>
  </div>

  <div class="searchBar" role="search" aria-label="Plot search">
    <input id="plotInput" placeholder="‡§™‡•ç‡§≤‡•â‡§ü ‡§®‡§Ç‡§¨‡§∞ ‡§°‡§æ‡§≤‡•á‡§Ç ‡§Ø‡§æ üé§ ‡§∏‡•á ‡§¨‡•ã‡§≤‡•á‡§Ç" aria-label="Plot number"/>
    <button id="micBtn" title="‡§¨‡•ã‡§≤‡§ï‡§∞ ‡§∏‡§∞‡•ç‡§ö ‡§ï‡§∞‡•á‡§Ç">üé§</button>
    <button id="searchBtn" title="‡§™‡•ç‡§≤‡•â‡§ü ‡§ñ‡•ã‡§ú‡•á‡§Ç">üîç</button>
  </div>

  <div id="msg" class="msg" role="status"></div>

  <!-- libs -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>

  <script>
  // CONFIG
  const GEOJSON_FILE = 'plots.geojson';
  const PLOT_PROP = 'Name';
  const DEFAULT_CENTER = [25.339365,85.765942];
  const DEFAULT_ZOOM = 18;
  const MAX_ZOOM = 22;

  // STATE
  let plotsLayer = null;
  let labelsLayer = L.layerGroup();
  let labelsShown = true;
  let voiceEnabled = true;
  let userMarker = null;
  let highlightLayer = null;
  let lastPlot = null; // Track last spoken plot to prevent voice repetition
  let lastPosition = null; // Track last position to prevent unnecessary panning
  const MIN_DISTANCE = 10; // Minimum distance (meters) to trigger map pan or voice

  // MAP
  const map = L.map('map', { maxZoom: MAX_ZOOM, minZoom: 13, zoomControl: false }).setView(DEFAULT_CENTER, DEFAULT_ZOOM);

  // try Google Satellite tiles
  const googleSat = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', { maxZoom: MAX_ZOOM, attribution: '¬© Google' });
  googleSat.addTo(map);

  // add zoom control at left (moved via CSS)
  L.control.zoom({ position: 'topleft' }).addTo(map);

  // add locate control with no auto-zoom/pan
  L.control.locate && L.control.locate({ 
    position: 'topleft', 
    strings: { title: "‡§Æ‡•á‡§∞‡•Ä ‡§≤‡•ã‡§ï‡•á‡§∂‡§®" },
    setView: false // Disable auto-zoom/pan
  }).addTo(map);

  // helper messages
  function showMsg(text, ms=2500){ 
    const e = document.getElementById('msg'); 
    e.style.display = 'block'; 
    e.innerText = text; 
    setTimeout(() => e.style.display = 'none', ms); 
  }

  // fetch GeoJSON
  fetch(GEOJSON_FILE)
  .then(r => { if(!r.ok) throw new Error('GeoJSON load error ' + r.status); return r.json(); })
  .then(data => {
    plotsLayer = L.geoJSON(data, {
      style: f => ({ color:'#ff7800', weight:1.5, fillOpacity:0.08 }),
      onEachFeature: (feature, layer) => {
        const plotNo = feature.properties && (feature.properties[PLOT_PROP] || feature.properties.plot_no || feature.properties.id) ? (feature.properties[PLOT_PROP]||feature.properties.plot_no||feature.properties.id) : 'Unknown';
        let areaSqFt = 'N/A';
        try{ const a = turf.area(feature); areaSqFt = (a * 10.763910416709722).toFixed(2); }catch(e){}
        let centroid = [0,0];
        try{ const c = turf.centroid(feature).geometry.coordinates; centroid = [c[1],c[0]];}catch(e){}
        const popup = `<div><strong>Plot: ${plotNo}</strong><br>Area: ${areaSqFt} sq ft<br>
          <a href="https://www.google.com/maps/search/?api=1&query=${centroid[0]},${centroid[1]}" target="_blank" rel="noopener">Google Maps ‡§Æ‡•á‡§Ç ‡§ñ‡•ã‡§≤‡•á‡§Ç</a></div>`;
        layer.bindPopup(popup);

        layer.on('click', () => {
          highlightFeature(feature);
          setInfo(`Plot: ${plotNo} ‚Äî Area: ${areaSqFt} sq ft`);
          if(voiceEnabled) speakHindi(`‡§Ü‡§™ ‡§™‡•ç‡§≤‡•â‡§ü ‡§®‡§Ç‡§¨‡§∞ ${plotNo} ‡§™‡§∞ ‡§π‡•à‡§Ç‡•§ ‡§á‡§∏‡§ï‡§æ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞‡§´‡§≤ ${areaSqFt} ‡§µ‡§∞‡•ç‡§ó ‡§´‡•Ä‡§ü ‡§π‡•à‡•§`);
        });
      }
    }).addTo(map);

    buildLabels(data);

    const b = plotsLayer.getBounds();
    if(b && b.isValid && b.isValid()) map.fitBounds(b, { padding:[20,20] });
    else map.setView(DEFAULT_CENTER, DEFAULT_ZOOM);

    document.getElementById('info').innerText = '‡§Æ‡•à‡§™ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§ "‡§Æ‡•á‡§∞‡•Ä ‡§≤‡•ã‡§ï‡•á‡§∂‡§®" ‡§¶‡§¨‡§æ‡§ï‡§∞ ‡§Ü‡§ú‡§º‡§Æ‡§æ‡§è‡§Å‡•§';
  })
  .catch(err => {
    console.error(err);
    document.getElementById('info').innerText = 'GeoJSON ‡§≤‡•ã‡§° ‡§è‡§∞‡§∞: ' + err.message;
    showMsg('GeoJSON ‡§≤‡•ã‡§° ‡§è‡§∞‡§∞: ' + err.message, 5000);
    map.setView(DEFAULT_CENTER, DEFAULT_ZOOM);
  });

  // build labels function
  function buildLabels(geojson){
    labelsLayer.clearLayers();
    if(!geojson || !geojson.features) return;
    geojson.features.forEach(f => {
      try{
        const c = turf.centroid(f).geometry.coordinates;
        const plotNo = (f.properties && (f.properties[PLOT_PROP] || f.properties.plot_no || f.properties.id)) ? (f.properties[PLOT_PROP] || f.properties.plot_no || f.properties.id) : '';
        const m = L.marker([c[1], c[0]], {
          icon: L.divIcon({ className:'plot-label', html:`<div style="background:rgba(255,255,255,0.95);padding:3px 6px;border-radius:6px;border:1px solid #ddd;font-weight:600">${plotNo}</div>` })
        });
        labelsLayer.addLayer(m);
      }catch(e){}
    });
    if(labelsShown) map.addLayer(labelsLayer);
  }

  // toggle labels
  document.getElementById('btnToggleLabels').addEventListener('click', () => {
    labelsShown = !labelsShown;
    if(labelsShown){ 
      map.addLayer(labelsLayer); 
      document.getElementById('btnToggleLabels').innerText = '‡§™‡•ç‡§≤‡•â‡§ü ‡§®‡§Ç‡§¨‡§∞ ‡§õ‡•Å‡§™‡§æ‡§è‡§Å'; 
    } else { 
      map.removeLayer(labelsLayer); 
      document.getElementById('btnToggleLabels').innerText = '‡§™‡•ç‡§≤‡•â‡§ü ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å'; 
    }
  });

  // fit button
  document.getElementById('btnFit').addEventListener('click', () => {
    if(plotsLayer){
      const b = plotsLayer.getBounds();
      if(b && b.isValid && b.isValid()) map.fitBounds(b, { padding:[20,20] });
    } else showMsg('Plots ‡§Ö‡§≠‡•Ä ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§è');
  });

  // zoom buttons
  document.getElementById('btnZoomIn').addEventListener('click', () => {
    map.zoomIn();
    showMsg('‡§ú‡§º‡•Ç‡§Æ ‡§á‡§® ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ', 1200);
  });
  document.getElementById('btnZoomOut').addEventListener('click', () => {
    map.zoomOut();
    showMsg('‡§ú‡§º‡•Ç‡§Æ ‡§Ü‡§â‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ', 1200);
  });

  // locate
  document.getElementById('btnLocate').addEventListener('click', () => {
    if(!navigator.geolocation){ showMsg('‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§Æ‡•á‡§Ç Geolocation ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à', 4000); return; }
    showMsg('‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§Æ‡§æ‡§Ç‡§ó‡•Ä ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à ‚Äî ‡§™‡§∞‡§Æ‡§ø‡§∂‡§® ‡§¶‡•á‡§Ç', 2000);
    navigator.geolocation.getCurrentPosition(posSuccess, posError, { enableHighAccuracy: true, timeout: 15000 });
  });

  function posSuccess(pos) {
    const lat = pos.coords.latitude, lng = pos.coords.longitude;
    const latlng = L.latLng(lat, lng);

    // Check if position has changed significantly (using Turf.js distance)
    if (lastPosition) {
      const distance = turf.distance(
        turf.point([lastPosition.lng, lastPosition.lat]),
        turf.point([lng, lat]),
        { units: 'meters' }
      );
      if (distance < MIN_DISTANCE) return; // Skip if movement is less than 10 meters
    }
    lastPosition = { lat, lng };

    if(userMarker) map.removeLayer(userMarker);
    userMarker = L.circleMarker(latlng, { radius: 7, color: '#1976d2', fillColor: '#1976d2', fillOpacity: 1 }).addTo(map);
    map.panTo(latlng); // Pan only, no zoom

    let found = null;
    if(plotsLayer){
      plotsLayer.eachLayer(layer => {
        try{
          if(turf.booleanPointInPolygon(turf.point([lng, lat]), layer.toGeoJSON())) found = layer.toGeoJSON();
        }catch(e){}
      });
    }

    const currentPlot = found ? (found.properties && (found.properties[PLOT_PROP] || found.properties.plot_no || found.properties.id) || 'Unknown') : null;
    if (currentPlot !== lastPlot) { // Speak only if plot changes
      lastPlot = currentPlot;
      if(found){
        const plotNo = currentPlot;
        const areaSqFt = (turf.area(found) * 10.763910416709722).toFixed(2);
        highlightFeature(found);
        setInfo(`‡§Ü‡§™ ‡§á‡§∏ ‡§™‡•ç‡§≤‡•â‡§ü ‡§™‡§∞ ‡§ñ‡§°‡§º‡•á ‡§π‡•à‡§Ç: ${plotNo} ‚Äî Area: ${areaSqFt} sq ft`);
        if(voiceEnabled) speakHindi(`‡§Ü‡§™ ‡§™‡•ç‡§≤‡•â‡§ü ‡§®‡§Ç‡§¨‡§∞ ${plotNo} ‡§™‡§∞ ‡§π‡•à‡§Ç‡•§ ‡§á‡§∏‡§ï‡§æ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞‡§´‡§≤ ${areaSqFt} ‡§µ‡§∞‡•ç‡§ó ‡§´‡•Ä‡§ü ‡§π‡•à‡•§`);
      } else {
        setInfo('‡§Ü‡§™ ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§™‡•ç‡§≤‡•â‡§ü ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡§Ç‡•§');
        if(voiceEnabled) speakHindi('‡§Ü‡§™ ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§™‡•ç‡§≤‡•â‡§ü ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡§Ç‡•§');
      }
    }
  }

  function posError(err) {
    console.warn('pos err', err);
    if(err && err.code === 1) showMsg('Location permission denied ‚Äî site settings ‡§∏‡•á allow ‡§ï‡§∞‡•á‡§Ç', 6000);
    else showMsg('Location error: ' + (err && err.message ? err.message : err), 4000);
  }

  // highlight helper
  function highlightFeature(feature) {
    try{ if(highlightLayer) map.removeLayer(highlightLayer); }catch(e){}
    highlightLayer = L.geoJSON(feature, { style: { color: '#00bfa5', weight: 3, fillOpacity: 0.25 } }).addTo(map);
    try{ 
      const c = turf.centroid(feature).geometry.coordinates; 
      map.panTo([c[1], c[0]]); // Pan only, no zoom
    }catch(e){}
  }

  // info box
  function setInfo(text) { document.getElementById('info').innerText = text; }

  // search functions
  document.getElementById('searchBtn').addEventListener('click', doSearch);
  document.getElementById('plotInput').addEventListener('keydown', (e) => { if(e.key === 'Enter') doSearch(); });

  function doSearch() {
    const q = document.getElementById('plotInput').value.trim();
    if(!q){ showMsg('‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§≤‡•â‡§ü ‡§®‡§Ç‡§¨‡§∞ ‡§°‡§æ‡§≤‡•á‡§Ç', 2000); return; }
    if(!plotsLayer){ showMsg('Plots ‡§Ö‡§≠‡•Ä ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§è', 2000); return; }
    let found = null;
    plotsLayer.eachLayer(layer => {
      try{
        const val = layer.feature && (layer.feature.properties[PLOT_PROP] || layer.feature.properties.plot_no || layer.feature.properties.id) ? (layer.feature.properties[PLOT_PROP] || layer.feature.properties.plot_no || layer.feature.properties.id) : '';
        if(String(val) === q) found = layer.toGeoJSON();
      }catch(e){}
    });
    if(found){
      highlightFeature(found);
      const area = (turf.area(found) * 10.763910416709722).toFixed(2);
      const c = turf.centroid(found).geometry.coordinates;
      setInfo(`Plot: ${q} ‚Äî Area: ${area} sq ft`);
      if(voiceEnabled) speakHindi(`‡§™‡•ç‡§≤‡•â‡§ü ‡§®‡§Ç‡§¨‡§∞ ${q} ‡§¶‡§ø‡§ñ‡§æ‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à‡•§ ‡§á‡§∏‡§ï‡§æ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞‡§´‡§≤ ${area} ‡§µ‡§∞‡•ç‡§ó ‡§´‡•Ä‡§ü‡•§`);
      L.popup({ maxWidth: 300, autoPan: false }).setLatLng([c[1], c[0]]).setContent(`<div><strong>Plot: ${q}</strong><br>Area: ${area} sq ft<br><a href="https://www.google.com/maps/search/?api=1&query=${c[1]},${c[0]}" target="_blank" rel="noopener">Google Maps ‡§Æ‡•á‡§Ç ‡§ñ‡•ã‡§≤‡•á‡§Ç</a></div>`).openOn(map);
    } else {
      showMsg('‡§™‡•ç‡§≤‡•â‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ: ' + q, 3000);
      if(voiceEnabled) speakHindi(`‡§™‡•ç‡§≤‡•â‡§ü ‡§®‡§Ç‡§¨‡§∞ ${q} ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ`);
    }
  }

  // voice search
  document.getElementById('micBtn').addEventListener('click', startVoiceSearch);
  function startVoiceSearch() {
    const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SpeechRec){ showMsg('‡§Ø‡§π ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§µ‡•â‡§á‡§∏ ‡§∏‡§∞‡•ç‡§ö ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡§æ', 4000); return; }
    const rec = new SpeechRec();
    rec.lang = 'hi-IN';
    rec.interimResults = false;
    rec.maxAlternatives = 1;
    rec.onstart = () => showMsg('‡§¨‡•ã‡§≤ ‡§ï‡§∞ ‡§™‡•ç‡§≤‡•â‡§ü ‡§®‡§Ç‡§¨‡§∞ ‡§¨‡§§‡§æ‡§á‡§è...', 2000);
    rec.onresult = (ev) => {
      const spoken = ev.results[0][0].transcript.trim();
      document.getElementById('plotInput').value = spoken;
      doSearch();
    };
    rec.onerror = e => { console.warn('speech err', e); showMsg('Speech error', 3000); };
    rec.start();
  }

  // toggle voice
  document.getElementById('btnVoiceToggle').addEventListener('click', () => {
    voiceEnabled = !voiceEnabled;
    document.getElementById('btnVoiceToggle').innerText = '‡§Ü‡§µ‡§æ‡§ú‡§º: ' + (voiceEnabled ? '‡§ö‡§æ‡§≤‡•Ç' : '‡§¨‡§Ç‡§¶');
    showMsg('‡§Ü‡§µ‡§æ‡§ú‡§º ' + (voiceEnabled ? '‡§ö‡§æ‡§≤‡•Ç' : '‡§¨‡§Ç‡§¶'), 1200);
  });

  // speak helper
  function speakHindi(txt) {
    try {
      window.speechSynthesis.cancel(); // Clear any existing speech
      const u = new SpeechSynthesisUtterance(txt);
      u.lang = 'hi-IN';
      u.onend = () => { window.speechSynthesis.cancel(); }; // Ensure queue is cleared after speaking
      window.speechSynthesis.speak(u);
    } catch(e) { console.warn('TTS err', e); }
  }

  // expose debug
  window._debug = { plotsLayer, labelsLayer, geojsonData: window.geojsonData };
  </script>
</body>
</html>